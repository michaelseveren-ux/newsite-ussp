---
import type { AircraftStatus, AircraftType } from '../types/aircraft';
import { getManufacturers, getAircraftTypes } from '../data/aircraft';

const manufacturers = await getManufacturers();
const aircraftTypes = await getAircraftTypes();

const statusOptions: { value: AircraftStatus | ''; label: string }[] = [
  { value: '', label: 'All Status' },
  { value: 'available', label: 'Available' },
  { value: 'pending', label: 'Sale Pending' },
  { value: 'sold', label: 'Sold' },
];

const typeLabels: Record<AircraftType, string> = {
  'light-sport': 'Light Sport',
  experimental: 'Experimental',
  ultralight: 'Ultralight',
  amphibious: 'Amphibious',
  gyroplane: 'Gyroplane',
};

const priceRanges = [
  { value: '', label: 'Any Price' },
  { value: '0-100000', label: 'Under $100,000' },
  { value: '100000-200000', label: '$100,000 - $200,000' },
  { value: '200000-300000', label: '$200,000 - $300,000' },
  { value: '300000-999999999', label: 'Over $300,000' },
];
---

<div class="bg-white rounded-xl shadow-md p-6 mb-8" id="aircraft-filters">
  <div class="flex flex-col md:flex-row md:items-center gap-4">
    <!-- Status Filter -->
    <div class="flex-1">
      <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">
        Status
      </label>
      <select
        id="filter-status"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500"
      >
        {statusOptions.map((option) => (
          <option value={option.value}>{option.label}</option>
        ))}
      </select>
    </div>

    <!-- Type Filter -->
    <div class="flex-1">
      <label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">
        Aircraft Type
      </label>
      <select
        id="filter-type"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500"
      >
        <option value="">All Types</option>
        {aircraftTypes.map((type) => (
          <option value={type}>{typeLabels[type]}</option>
        ))}
      </select>
    </div>

    <!-- Manufacturer Filter -->
    <div class="flex-1">
      <label for="filter-manufacturer" class="block text-sm font-medium text-gray-700 mb-1">
        Manufacturer
      </label>
      <select
        id="filter-manufacturer"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500"
      >
        <option value="">All Manufacturers</option>
        {manufacturers.map((manufacturer) => (
          <option value={manufacturer}>{manufacturer}</option>
        ))}
      </select>
    </div>

    <!-- Price Filter -->
    <div class="flex-1">
      <label for="filter-price" class="block text-sm font-medium text-gray-700 mb-1">
        Price Range
      </label>
      <select
        id="filter-price"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500"
      >
        {priceRanges.map((range) => (
          <option value={range.value}>{range.label}</option>
        ))}
      </select>
    </div>

    <!-- Reset Button -->
    <div class="flex-shrink-0 self-end">
      <button
        type="button"
        id="filter-reset"
        class="px-4 py-2 text-gray-600 hover:text-primary-900 font-medium transition-colors"
      >
        Reset
      </button>
    </div>
  </div>

  <!-- Results Count -->
  <div class="mt-4 pt-4 border-t border-gray-100">
    <p class="text-gray-600">
      Showing <span id="filter-count" class="font-semibold text-primary-900">0</span> aircraft
    </p>
  </div>
</div>

<script>
  // Client-side filtering
  const filterStatus = document.getElementById('filter-status') as HTMLSelectElement;
  const filterType = document.getElementById('filter-type') as HTMLSelectElement;
  const filterManufacturer = document.getElementById('filter-manufacturer') as HTMLSelectElement;
  const filterPrice = document.getElementById('filter-price') as HTMLSelectElement;
  const resetBtn = document.getElementById('filter-reset');
  const countSpan = document.getElementById('filter-count');

  function applyFilters() {
    const status = filterStatus?.value || '';
    const type = filterType?.value || '';
    const manufacturer = filterManufacturer?.value || '';
    const priceRange = filterPrice?.value || '';

    const cards = document.querySelectorAll('[data-aircraft-card]');
    let visibleCount = 0;

    cards.forEach((card) => {
      const cardStatus = card.getAttribute('data-status') || '';
      const cardType = card.getAttribute('data-type') || '';
      const cardManufacturer = card.getAttribute('data-manufacturer') || '';
      const cardPrice = parseInt(card.getAttribute('data-price') || '0', 10);

      let visible = true;

      // Status filter
      if (status && cardStatus !== status) {
        visible = false;
      }

      // Type filter
      if (type && cardType !== type) {
        visible = false;
      }

      // Manufacturer filter
      if (manufacturer && cardManufacturer !== manufacturer) {
        visible = false;
      }

      // Price filter
      if (priceRange) {
        const [min, max] = priceRange.split('-').map(Number);
        if (cardPrice < min || cardPrice > max) {
          visible = false;
        }
      }

      // Toggle visibility
      if (visible) {
        (card as HTMLElement).style.display = '';
        visibleCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    // Update count
    if (countSpan) {
      countSpan.textContent = String(visibleCount);
    }
  }

  function resetFilters() {
    if (filterStatus) filterStatus.value = '';
    if (filterType) filterType.value = '';
    if (filterManufacturer) filterManufacturer.value = '';
    if (filterPrice) filterPrice.value = '';
    applyFilters();
  }

  // Add event listeners
  filterStatus?.addEventListener('change', applyFilters);
  filterType?.addEventListener('change', applyFilters);
  filterManufacturer?.addEventListener('change', applyFilters);
  filterPrice?.addEventListener('change', applyFilters);
  resetBtn?.addEventListener('click', resetFilters);

  // Initial count
  applyFilters();
</script>
