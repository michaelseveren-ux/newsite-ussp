---
interface Props {
  url: string;
  title?: string;
}

const { url, title = 'Video' } = Astro.props;

// Parse video URL and extract embed info
function getEmbedUrl(videoUrl: string): { embedUrl: string | null; isValid: boolean } {
  try {
    const urlObj = new URL(videoUrl);
    const hostname = urlObj.hostname.replace('www.', '');

    // YouTube
    if (hostname === 'youtube.com' || hostname === 'youtu.be') {
      let videoId: string | null = null;

      if (hostname === 'youtu.be') {
        videoId = urlObj.pathname.slice(1);
      } else if (urlObj.pathname === '/watch') {
        videoId = urlObj.searchParams.get('v');
      } else if (urlObj.pathname.startsWith('/embed/')) {
        videoId = urlObj.pathname.replace('/embed/', '');
      }

      if (videoId) {
        return {
          embedUrl: `https://www.youtube.com/embed/${videoId}`,
          isValid: true,
        };
      }
    }

    // Vimeo
    if (hostname === 'vimeo.com') {
      const videoId = urlObj.pathname.slice(1);
      if (videoId && /^\d+$/.test(videoId)) {
        return {
          embedUrl: `https://player.vimeo.com/video/${videoId}`,
          isValid: true,
        };
      }
    }

    return { embedUrl: null, isValid: false };
  } catch {
    return { embedUrl: null, isValid: false };
  }
}

const { embedUrl, isValid } = getEmbedUrl(url);
---

{isValid && embedUrl ? (
  <div class="relative w-full aspect-video rounded-xl overflow-hidden shadow-lg">
    <iframe
      src={embedUrl}
      title={title}
      class="absolute inset-0 w-full h-full"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
    ></iframe>
  </div>
) : (
  <div class="bg-gray-100 rounded-xl p-6 text-center">
    <p class="text-gray-600 mb-2">Video could not be embedded.</p>
    <a
      href={url}
      target="_blank"
      rel="noopener noreferrer"
      class="text-accent-600 hover:text-accent-700 font-medium inline-flex items-center gap-1"
    >
      Watch on external site
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
      </svg>
    </a>
  </div>
)}
